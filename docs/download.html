<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>SED Email Downloader</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            text-align: center;
        }
        .status {
            font-size: 14px;
            margin: 10px 0;
        }
        .downloading {
            color: #0078d4;
        }
        .success {
            color: #107c10;
        }
        .error {
            color: #d13438;
        }
    </style>
</head>
<body>
    <div id="status" class="status downloading">SED Email Downloader: Initializing...</div>

    <script>
        const msalConfig = {
          auth: {
            clientId: "10f65a22-c90e-44bc-9c3f-dbb90c8d6a92",
            redirectUri: "https://alvar0murga.github.io/download-email-eml/"
          },
          cache: {
            cacheLocation: "sessionStorage",
            storeAuthStateInCookie: false,
          }
        };

        let msalInstance = null;

        async function initializeMsal() {
          if (msalInstance) {
            return msalInstance;
          }
          
          try {
            msalInstance = new msal.PublicClientApplication(msalConfig);
            await msalInstance.initialize();
            return msalInstance;
          } catch (error) {
            console.error("Error initializing MSAL:", error);
            msalInstance = null;
            throw error;
          }
        }

        async function getToken() {
          if (!msalInstance) {
            await initializeMsal();
          }
          
          let account = msalInstance.getAllAccounts()[0];
          if (!account) {
            // Try to sign in
            const loginRequest = {
              scopes: ["https://graph.microsoft.com/Mail.Read"]
            };
            const loginResponse = await msalInstance.loginPopup(loginRequest);
            account = loginResponse.account;
          }

          const tokenRequest = {
            scopes: ["https://graph.microsoft.com/Mail.Read"],
            account: account
          };

          try {
            const response = await msalInstance.acquireTokenSilent(tokenRequest);
            return response.accessToken;
          } catch (error) {
            if (error instanceof msal.InteractionRequiredAuthError) {
              const response = await msalInstance.acquireTokenPopup(tokenRequest);
              return response.accessToken;
            } else {
              throw error;
            }
          }
        }

        async function downloadEmail() {
          const statusDiv = document.getElementById("status");
          
          try {
            statusDiv.textContent = "SED Email Downloader: Authenticating...";
            
            await initializeMsal();
            const accessToken = await getToken();

            statusDiv.textContent = "SED Email Downloader: Downloading email...";

            // Get email info from parent window (Outlook)
            const itemId = Office.context.mailbox.item.itemId;
            const subject = Office.context.mailbox.item.subject || "email";
            const graphItemId = encodeURIComponent(itemId);

            const response = await fetch(`https://graph.microsoft.com/v1.0/me/messages/${graphItemId}/$value`, {
              headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Accept": "message/rfc822"
              }
            });

            if (!response.ok) {
              throw new Error(`Graph API error: ${response.status} ${response.statusText}`);
            }

            const emlBlob = await response.blob();
            const filename = subject.replace(/[/\\?%*:|"<>]/g, '-') + ".eml";

            // Create download link
            const url = URL.createObjectURL(emlBlob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            statusDiv.className = "status success";
            statusDiv.textContent = "✅ Download completed successfully!";

            // Send success message to parent
            Office.context.ui.messageParent(JSON.stringify({
              type: "success",
              message: "Download completed"
            }));

          } catch (error) {
            console.error("Download error:", error);
            statusDiv.className = "status error";
            statusDiv.textContent = `❌ Error: ${error.message}`;

            // Send error message to parent
            Office.context.ui.messageParent(JSON.stringify({
              type: "error",
              error: error.message
            }));
          }
        }

        // Initialize and start download when ready
        Office.onReady(() => {
          downloadEmail();
        });
    </script>
</body>
</html>
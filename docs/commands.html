<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
</head>
<body>
    <script>
        /* Azure AD MSAL config */
        const msalConfig = {
          auth: {
            clientId: "10f65a22-c90e-44bc-9c3f-dbb90c8d6a92",
            redirectUri: "https://alvar0murga.github.io/download-email-eml/"
          },
          cache: {
            cacheLocation: "sessionStorage",
            storeAuthStateInCookie: false,
          }
        };

        let msalInstance = null;

        async function initializeMsal() {
          if (msalInstance) {
            return msalInstance;
          }
          
          try {
            msalInstance = new msal.PublicClientApplication(msalConfig);
            await msalInstance.initialize();
            console.log("MSAL Initialized successfully");
            return msalInstance;
          } catch (error) {
            console.error("Error initializing MSAL:", error);
            msalInstance = null;
            throw error;
          }
        }

        async function signIn() {
          if (!msalInstance) {
            throw new Error("MSAL not initialized");
          }
          
          const loginRequest = {
            scopes: ["https://graph.microsoft.com/Mail.Read"]
          };

          try {
            const loginResponse = await msalInstance.loginPopup(loginRequest);
            return loginResponse.account;
          } catch (error) {
            console.error("Login error:", error);
            throw error;
          }
        }

        async function getToken() {
          if (!msalInstance) {
            await initializeMsal();
          }
          
          let account = msalInstance.getAllAccounts()[0];
          if (!account) {
            account = await signIn();
          }

          const tokenRequest = {
            scopes: ["https://graph.microsoft.com/Mail.Read"],
            account: account
          };

          try {
            const response = await msalInstance.acquireTokenSilent(tokenRequest);
            return response.accessToken;
          } catch (error) {
            if (error instanceof msal.InteractionRequiredAuthError) {
              const response = await msalInstance.acquireTokenPopup(tokenRequest);
              return response.accessToken;
            } else {
              console.error("Token acquisition error:", error);
              throw error;
            }
          }
        }

        // Function called by the button
        async function downloadEmail(event) {
          try {
            // Show progress notification
            Office.context.mailbox.item.notificationMessages.replaceAsync("download", {
              type: "informationalMessage",
              message: "SED Email Downloader: Starting download...",
              icon: "Icon.16x16",
              persistent: false
            });

            await initializeMsal();
            const accessToken = await getToken();
            const itemId = Office.context.mailbox.item.itemId;
            const graphItemId = encodeURIComponent(itemId);

            // Update notification
            Office.context.mailbox.item.notificationMessages.replaceAsync("download", {
              type: "informationalMessage",
              message: "SED Email Downloader: Downloading email...",
              icon: "Icon.16x16",
              persistent: false
            });

            const response = await fetch(`https://graph.microsoft.com/v1.0/me/messages/${graphItemId}/$value`, {
              headers: {
                "Authorization": `Bearer ${accessToken}`,
                "Accept": "message/rfc822"
              }
            });

            if (!response.ok) {
              throw new Error(`Graph API error: ${response.status} ${response.statusText}`);
            }

            const emlBlob = await response.blob();
            const subject = Office.context.mailbox.item.subject || "email";
            const filename = subject.replace(/[/\\?%*:|"<>]/g, '-') + ".eml";

            // Create download link
            const url = URL.createObjectURL(emlBlob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            // Success notification
            Office.context.mailbox.item.notificationMessages.replaceAsync("download", {
              type: "informationalMessage",
              message: "SED Email Downloader: Download completed successfully!",
              icon: "Icon.16x16",
              persistent: false
            });

            // Clear notification after 3 seconds
            setTimeout(() => {
              Office.context.mailbox.item.notificationMessages.removeAsync("download");
            }, 3000);

          } catch (error) {
            console.error("Download error:", error);
            
            // Error notification
            Office.context.mailbox.item.notificationMessages.replaceAsync("download", {
              type: "errorMessage",
              message: `SED Email Downloader: Error - ${error.message}`,
              icon: "Icon.16x16",
              persistent: true
            });
          }

          // Complete the function
          event.completed();
        }

        // Initialize Office
        Office.onReady(() => {
          console.log("SED Email Downloader Commands ready");
        });
    </script>
</body>
</html>
